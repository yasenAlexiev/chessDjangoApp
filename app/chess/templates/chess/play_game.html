{% extends 'chess/base.html' %}
{% load static %}

{% block title %}Game {{ game.id }}{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h2>Game #{{ game.id }}</h2>
        <div class="chess-board" id="chessBoard"></div>
    </div>

    <script>
        let selectedSquare = null;
        let validMoves = [];
        // Convert the board data to a JavaScript array
        let board = JSON.parse('{{ board|safe }}');
        console.log('Initial board state:', board);
        
        function initializeBoard() {
            const chessBoard = document.getElementById('chessBoard');
            chessBoard.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = `chess-square ${(row + col) % 2 === 0 ? 'white' : 'black'}`;
                    square.dataset.row = row;
                    square.dataset.col = col;
                    
                    const piece = board[row][col];
                    console.log(`Square [${row}][${col}]:`, piece); // Debug log
                    
                    if (piece && typeof piece === 'string' && piece.length >= 2) {
                        const img = document.createElement('img');
                        img.src = getPieceImageUrl(piece);
                        img.alt = piece;
                        square.appendChild(img);
                    }
                    
                    square.addEventListener('click', handleSquareClick);
                    chessBoard.appendChild(square);
                }
            }
        }

        function getPieceImageUrl(piece) {
            try {
                if (!piece || typeof piece !== 'string' || piece.length < 2) {
                    console.error('Invalid piece data:', piece);
                    return '';
                }

                // Use the 2-letter format directly (e.g., 'wK.svg', 'bN.svg')
                const url = `{% static 'chess/pieces/' %}${piece}.svg`;
                console.log('Generated URL:', url); // Debug log
                return url;
            } catch (error) {
                console.error('Error in getPieceImageUrl:', error);
                return '';
            }
        }

        function handleSquareClick(event) {
            const square = event.currentTarget;
            const row = parseInt(square.dataset.row);
            const col = parseInt(square.dataset.col);
            const piece = board[row][col];
            
            // Clear previous selection and highlights
            document.querySelectorAll('.chess-square').forEach(sq => {
                sq.classList.remove('selected', 'valid-move');
            });
            
            if (selectedSquare) {
                // If a square was already selected, attempt to make a move
                const fromRow = parseInt(selectedSquare.dataset.row);
                const fromCol = parseInt(selectedSquare.dataset.col);
                
                // Check if the move is valid
                const isValidMove = validMoves.some(move => 
                    move.toRow === row && move.toCol === col
                );
                
                if (isValidMove) {
                    // Make the move
                    makeMove(fromRow, fromCol, row, col);
                }
                
                selectedSquare = null;
                validMoves = [];
            } else if (piece) {
                // If no square is selected and clicked square has a piece, select it
                const isWhitePiece = piece[0] === 'w';
                const isCurrentPlayerWhite = {{ is_white|yesno:"true,false" }};
                
                // Only allow selecting pieces of the current player's color
                if ((isWhitePiece && isCurrentPlayerWhite) || (!isWhitePiece && !isCurrentPlayerWhite)) {
                    selectedSquare = square;
                    square.classList.add('selected');
                    
                    // Get valid moves for the selected piece
                    validMoves = getValidMoves(fromRow, fromCol);
                    
                    // Highlight valid moves
                    validMoves.forEach(move => {
                        const targetSquare = document.querySelector(
                            `.chess-square[data-row="${move.toRow}"][data-col="${move.toCol}"]`
                        );
                        if (targetSquare) {
                            targetSquare.classList.add('valid-move');
                        }
                    });
                }
            }
        }

        function getValidMoves(fromRow, fromCol) {
            const piece = board[fromRow][fromCol];
            if (!piece) return [];
            
            const moves = [];
            const pieceType = piece[1].toLowerCase();
            const isWhite = piece[0] === 'w';
            
            // Basic movement patterns for each piece type
            switch (pieceType) {
                case 'p': // Pawn
                    const direction = isWhite ? -1 : 1;
                    const startRow = isWhite ? 6 : 1;
                    
                    // Forward move
                    if (isValidSquare(fromRow + direction, fromCol) && !board[fromRow + direction][fromCol]) {
                        moves.push({ toRow: fromRow + direction, toCol: fromCol });
                        
                        // Double move from starting position
                        if (fromRow === startRow && !board[fromRow + 2 * direction][fromCol]) {
                            moves.push({ toRow: fromRow + 2 * direction, toCol: fromCol });
                        }
                    }
                    
                    // Captures
                    const captureCols = [fromCol - 1, fromCol + 1];
                    captureCols.forEach(col => {
                        if (isValidSquare(fromRow + direction, col)) {
                            const targetPiece = board[fromRow + direction][col];
                            if (targetPiece && targetPiece[0] !== piece[0]) {
                                moves.push({ toRow: fromRow + direction, toCol: col });
                            }
                        }
                    });
                    break;
                    
                case 'n': // Knight
                    const knightMoves = [
                        [-2, -1], [-2, 1], [-1, -2], [-1, 2],
                        [1, -2], [1, 2], [2, -1], [2, 1]
                    ];
                    knightMoves.forEach(([dRow, dCol]) => {
                        const toRow = fromRow + dRow;
                        const toCol = fromCol + dCol;
                        if (isValidSquare(toRow, toCol)) {
                            const targetPiece = board[toRow][toCol];
                            if (!targetPiece || targetPiece[0] !== piece[0]) {
                                moves.push({ toRow, toCol });
                            }
                        }
                    });
                    break;
                    
                // Add more piece movement patterns here
                // For now, we'll just implement pawn and knight moves
            }
            
            return moves;
        }

        function isValidSquare(row, col) {
            return row >= 0 && row < 8 && col >= 0 && col < 8;
        }

        function makeMove(fromRow, fromCol, toRow, toCol) {
            fetch(`/chess/game/${game.id}/move/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    from_row: fromRow,
                    from_col: fromCol,
                    to_row: toRow,
                    to_col: toCol
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    board = data.board;
                    initializeBoard();
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while making the move.');
            });
        }

        // Initialize the board when the page loads
        document.addEventListener('DOMContentLoaded', initializeBoard);
    </script>
{% endblock %}